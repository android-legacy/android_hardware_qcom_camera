From 386ae2225e4fd9184748d0f4cb6728183b9a9d90 Mon Sep 17 00:00:00 2001
From: Fei Zhang <feizhang@codeaurora.org>
Date: Fri, 28 Mar 2014 15:49:33 +0800
Subject: [PATCH 117/176] QCamera2: change the logic of pthread_cond_wait

Don't unlock mutex before cond_wait,
to avoid race condition.

Change-Id: I3896382ff67778b8543657cbb5d2a055969e938a
CRs-fixed: 621836
---
 QCamera2/HAL/QCameraStream.cpp | 6 ++----
 1 file changed, 2 insertions(+), 4 deletions(-)

diff --git a/QCamera2/HAL/QCameraStream.cpp b/QCamera2/HAL/QCameraStream.cpp
index cf1e920..7300456 100644
--- a/QCamera2/HAL/QCameraStream.cpp
+++ b/QCamera2/HAL/QCameraStream.cpp
@@ -780,12 +780,10 @@ void QCameraStream::cond_signal()
 void QCameraStream::cond_wait()
 {
     pthread_mutex_lock(&m_lock);
-    if(wait_for_cond == TRUE){
-        pthread_mutex_unlock(&m_lock);
+    while (wait_for_cond == TRUE) {
         pthread_cond_wait(&m_cond, &m_lock);
-    }else{
-        pthread_mutex_unlock(&m_lock);
     }
+    pthread_mutex_unlock(&m_lock);
 }
 
 /*===========================================================================
-- 
1.8.3.1

